
  services:
    db:
      image: postgres:15
      container_name: db
      restart: unless-stopped
      environment:
        POSTGRES_USER: ${POSTGRES_USER}
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
        POSTGRES_DB: ${POSTGRES_DB:-postgres}
        # application DB vars are also passed for external apps to create/consume
        APP_DB: ${APP_DB}
        APP_DB_USER: ${APP_DB_USER}
        APP_DB_PASSWORD: ${APP_DB_PASSWORD}
      volumes:
        - db-data:/var/lib/postgresql/data
        - ./db/init:/docker-entrypoint-initdb.d:ro
      healthcheck:
        test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} -q || exit 1"]
        interval: 10s
        timeout: 5s
        retries: 12
        start_period: 30s
      ports:
        - "5432:5432"

    vault:
      build:
        context: ./vault
        dockerfile: Dockerfile
      image: vault-local:1.21.1
      container_name: vault
      restart: unless-stopped
      cap_add:
        - IPC_LOCK
      environment:
        VAULT_ADDR: "http://127.0.0.1:8200"
        VAULT_LOG_LEVEL: ${VAULT_LOG_LEVEL:-info}
      volumes:
        - vault-data:/vault/data
        - ./vault/vault.hcl.tpl:/vault/config/vault.hcl.tpl:ro
        - ./vault/docker-entrypoint.sh:/usr/local/bin/vault-docker-entrypoint.sh:ro
        - ./vault/init:/vault/init        # SHARE: init artifacts written here
      ports:
        - "8200:8200"
      healthcheck:
        test: ["CMD-SHELL", "VAULT_ADDR=http://127.0.0.1:8200 vault status -format=json >/dev/null 2>&1"]
        interval: 5s
        timeout: 5s
        retries: 8
        start_period: 20s

    keycloak:
      image: quay.io/keycloak/keycloak:26.0
      container_name: keycloak
      restart: unless-stopped
      environment:
        KC_HTTP_ENABLED: "true"
        KC_HOSTNAME: "http://keycloak:8080"
        KC_HOSTNAME_BACKCHANNEL_DYNAMIC: "true"
        KC_HEALTH_ENABLED: "true"
        KC_BOOTSTRAP_ADMIN_USERNAME: ${KEYCLOAK_ADMIN_USER}
        KC_BOOTSTRAP_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
        KEYCLOAK_ADMIN_CLIENT: ${KEYCLOAK_ADMIN_CLIENT}
        KEYCLOAK_ADMIN_CLIENT_SECRET: ${KEYCLOAK_ADMIN_CLIENT_SECRET}
        KEYCLOAK_CONSUMER_CLIENT: ${KEYCLOAK_CONSUMER_CLIENT}
        KEYCLOAK_CONSUMER_CLIENT_SECRET: ${KEYCLOAK_CONSUMER_CLIENT_SECRET}
        KEYCLOAK_REDIRECT_URI: ${KEYCLOAK_REDIRECT_URI:-http://localhost:8081/*}
        KEYCLOAK_WEB_ORIGIN: ${KEYCLOAK_WEB_ORIGIN:-http://localhost:8081}
        KEYCLOAK_SSL_REQUIRED: ${KEYCLOAK_SSL_REQUIRED:-none}
        KEYCLOAK_ACCESS_TOKEN_LIFESPAN: ${KEYCLOAK_ACCESS_TOKEN_LIFESPAN:-3600}
        KEYCLOAK_SSO_SESSION_IDLE_TIMEOUT: ${KEYCLOAK_SSO_SESSION_IDLE_TIMEOUT:-4200}
        KEYCLOAK_SSO_SESSION_MAX_LIFESPAN: ${KEYCLOAK_SSO_SESSION_MAX_LIFESPAN:-4200}
        KEYCLOAK_CLIENT_TOKEN_LIFESPAN: ${KEYCLOAK_CLIENT_TOKEN_LIFESPAN:-3600}
      entrypoint: ["/bin/bash", "-c"]
      command:
        - |
          # Install envsubst if not available
          microdnf install -y gettext 2>/dev/null || true
          # Process the realm template
          mkdir -p /opt/keycloak/data/import
          envsubst < /opt/keycloak/data/import-templates/statement-service-realm.json > /opt/keycloak/data/import/statement-service-realm.json
          # Start Keycloak
          exec /opt/keycloak/bin/kc.sh start-dev --import-realm
      volumes:
        - keycloak-data:/opt/keycloak/data
        - ./keycloak/realms:/opt/keycloak/data/import-templates:ro
      ports:
        - "8081:8080"
      healthcheck:
        test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /realms/statement-service HTTP/1.1\r\nHost: localhost\r\nConnection: close\r\n\r\n' >&3 && cat <&3 | grep -q 'statement-service'"]
        interval: 10s
        timeout: 5s
        retries: 6
        start_period: 30s

    config-server:
      build:
        context: ..
        dockerfile: config-server/docker/Dockerfile
      image: config-server:latest
      environment:
        - VAULT_ADDR=http://vault:8200
        - APPROLE_ROLE_ID_FILE=/vault/init/approle-role-id
        - APPROLE_SECRET_ID_FILE=/vault/init/approle-secret-id
      volumes:
        - ./vault/init:/vault/init:ro
        - ./config-repo:/config-repo:ro
      depends_on:
        vault:
          condition: service_healthy
      ports:
        - "8888:8888"
      healthcheck:
        test: ["CMD-SHELL", "curl -fsS http://localhost:8888/actuator/health || exit 1"]
        interval: 10s
        timeout: 5s
        retries: 6
        start_period: 30s

    statement-service:
      build:
        context: ..
        dockerfile: statement-service/docker/Dockerfile
      image: statement-service:latest
      container_name: statement-service
      restart: unless-stopped
      environment:
        - SPRING_PROFILES_ACTIVE=develop
        - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
        - CONFIG_URL=http://config-server:8888/actuator/health
        - APP_DB_USER=${APP_DB_USER}
        - APP_DB_PASSWORD=${APP_DB_PASSWORD}
        - STATEMENT_STORAGE_DIR=/app/data/files
        - STATEMENT_MASTER_KEY=${STATEMENT_MASTER_KEY}
        - STATEMENT_SIGNATURE_SECRET=${STATEMENT_SIGNATURE_SECRET}
      volumes:
        - statement-data:/app/data/files
      depends_on:
        config-server:
          condition: service_healthy
        db:
          condition: service_healthy
        keycloak:
          condition: service_healthy
      ports:
        - "8080:8080"
      healthcheck:
        test: ["CMD-SHELL", "curl -fsS http://localhost:8080/api/v1/statements/actuator/health || exit 1"]
        interval: 10s
        timeout: 5s
        retries: 6
        start_period: 60s
  volumes:
    db-data:
    vault-data:
    keycloak-data:
    statement-data:
